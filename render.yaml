# ════════════════════════════════════════════════════════════════════════════
#  Scanctum — Render Blueprint
#  One-click deploy: https://dashboard.render.com/select-repo
#  Docs: https://render.com/docs/blueprint-spec
# ════════════════════════════════════════════════════════════════════════════

databases:
  # ── Managed PostgreSQL 16 ─────────────────────────────────────────────────
  - name: scanctum-db
    databaseName: scanctum
    user: scanctum
    plan: free           # upgrade to starter/standard for production
    region: oregon       # match region of your web services
    postgresMajorVersion: "16"

services:
  # ── FastAPI Backend ────────────────────────────────────────────────────────
  - type: web
    name: scanctum-backend
    region: oregon
    plan: free           # upgrade to starter ($7/mo) for persistent instances
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    # Run Alembic migrations then start Uvicorn
    dockerCommand: >
      sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2"
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: scanctum-db
          property: connectionString
        # Render provides postgresql:// — rewrite to asyncpg driver:
        transform: "value.replace('postgresql://', 'postgresql+asyncpg://')"
      - key: DATABASE_URL_SYNC
        fromDatabase:
          name: scanctum-db
          property: connectionString
        # Rewrite to psycopg2 driver for Celery/Alembic:
        transform: "value.replace('postgresql://', 'postgresql+psycopg2://')"
      - key: REDIS_URL
        fromService:
          name: scanctum-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET_KEY
        generateValue: true   # Render auto-generates a random secret
      - key: JWT_ALGORITHM
        value: HS256
      - key: JWT_EXPIRE_MINUTES
        value: "480"
      - key: BACKEND_CORS_ORIGINS
        value: '["https://scanctum-frontend.onrender.com"]'
      - key: API_V1_PREFIX
        value: /api/v1
      - key: SCANNER_MAX_DEPTH_QUICK
        value: "2"
      - key: SCANNER_MAX_PAGES_QUICK
        value: "20"
      - key: SCANNER_MAX_DEPTH_FULL
        value: "5"
      - key: SCANNER_MAX_PAGES_FULL
        value: "100"
      - key: SCANNER_REQUEST_DELAY
        value: "2.0"
      - key: SCANNER_CONCURRENCY
        value: "3"

  # ── Celery Worker ─────────────────────────────────────────────────────────
  - type: worker
    name: scanctum-celery
    region: oregon
    plan: free
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2 --prefetch-multiplier=1
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: scanctum-db
          property: connectionString
        transform: "value.replace('postgresql://', 'postgresql+asyncpg://')"
      - key: DATABASE_URL_SYNC
        fromDatabase:
          name: scanctum-db
          property: connectionString
        transform: "value.replace('postgresql://', 'postgresql+psycopg2://')"
      - key: REDIS_URL
        fromService:
          name: scanctum-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET_KEY
        fromService:
          name: scanctum-backend
          type: web
          envVarKey: JWT_SECRET_KEY
      - key: JWT_ALGORITHM
        value: HS256

  # ── Next.js Frontend ──────────────────────────────────────────────────────
  - type: web
    name: scanctum-frontend
    region: oregon
    plan: free
    env: docker
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: https://scanctum-backend.onrender.com/api/v1

  # ── Redis (Render managed) ─────────────────────────────────────────────────
  - type: redis
    name: scanctum-redis
    region: oregon
    plan: free           # 25MB free; upgrade to starter for persistence
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []      # Only allow internal Render network
