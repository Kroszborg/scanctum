# ════════════════════════════════════════════════════════════════════════════
#  Scanctum — Render Blueprint
#  Deploy: Dashboard → New → Blueprint → select repo → Deploy Blueprint
#  Docs: https://render.com/docs/blueprint-spec
# ════════════════════════════════════════════════════════════════════════════

databases:
  - name: scanctum-db
    databaseName: scanctum
    user: scanctum
    plan: free
    region: oregon
    postgresMajorVersion: "16"

services:
  # Redis must be defined before backend/celery so they can reference it
  - type: redis
    name: scanctum-redis
    region: oregon
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []   # internal only

  - type: web
    name: scanctum-backend
    region: oregon
    plan: free
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    # Render gives postgresql://; we need +asyncpg and +psycopg2 (no transform in Blueprint)
    dockerCommand: >
      sh -c 'export DATABASE_URL=$$(echo "$$DATABASE_URL" | sed "s|^postgresql://|postgresql+asyncpg://|");
      export DATABASE_URL_SYNC=$$(echo "$$DATABASE_URL_SYNC" | sed "s|^postgresql://|postgresql+psycopg2://|");
      alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $$PORT --workers 2'
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: scanctum-db
          property: connectionString
      - key: DATABASE_URL_SYNC
        fromDatabase:
          name: scanctum-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: scanctum-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: JWT_ALGORITHM
        value: HS256
      - key: JWT_EXPIRE_MINUTES
        value: "480"
      - key: BACKEND_CORS_ORIGINS
        value: '["https://scanctum-frontend.onrender.com"]'
      - key: API_V1_PREFIX
        value: /api/v1
      - key: SCANNER_MAX_DEPTH_QUICK
        value: "3"
      - key: SCANNER_MAX_PAGES_QUICK
        value: "40"
      - key: SCANNER_MAX_DEPTH_FULL
        value: "6"
      - key: SCANNER_MAX_PAGES_FULL
        value: "250"
      - key: SCANNER_REQUEST_DELAY
        value: "2.0"
      - key: SCANNER_CONCURRENCY
        value: "5"

  - type: worker
    name: scanctum-celery
    region: oregon
    plan: free
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: >
      sh -c 'export DATABASE_URL_SYNC=$$(echo "$$DATABASE_URL_SYNC" | sed "s|^postgresql://|postgresql+psycopg2://|");
      celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2 --prefetch-multiplier=1'
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: scanctum-db
          property: connectionString
      - key: DATABASE_URL_SYNC
        fromDatabase:
          name: scanctum-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: scanctum-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET_KEY
        fromService:
          name: scanctum-backend
          type: web
          envVarKey: JWT_SECRET_KEY
      - key: JWT_ALGORITHM
        value: HS256

  - type: web
    name: scanctum-frontend
    region: oregon
    plan: free
    runtime: docker
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: https://scanctum-backend.onrender.com/api/v1
